use super::{INV_SQRT_E as X0, NEG_INV_E as Z0};

#[cfg(feature = "fma")]
use fast_polynomial::polynomials::poly_3;

#[cfg(not(feature = "fma"))]
/// The original implementation of the secondary branch of the Lambert W function by Toshio Fukushima, accurate to 24 bits, ported to Rust.
pub fn swm1(z: f64) -> Option<f64> {
    if z < Z0 {
        None
    } else if z <= -0.207_293_777_640_384_15 {
        // W >= -2.483, Y_-1
        let x = -z / (X0 + (z - Z0).sqrt());
        Some(
            (-6.383_722_822_801_905
                + x * (-74.968_653_259_594_05
                    + x * (-19.714_821_552_432_483 + x * 70.677_326_667_809_24)))
                / (1.
                    + x * (24.295_836_951_878_69
                        + x * (64.112_460_611_386_04 + x * 17.994_497_369_039_312))),
        )
    } else if z <= -0.071_507_705_083_841_95 {
        // W >= -4.032, Y_-2
        let x = -z / (X0 + (z - Z0).sqrt());
        Some(
            (-7.723_328_481_229_978
                + x * (-352.484_690_970_429_14
                    + x * (-1_242.008_890_368_567_8 + x * 1_171.647_596_062_049_8)))
                / (1.
                    + x * (77.681_242_588_997_4
                        + x * (648.564_312_140_752_5 + x * 566.701_549_764_361_6))),
        )
    } else if z <= -0.020_704_412_621_717_48 {
        // W >= -5.600, Y_-3
        let x = -z / (X0 + (z - Z0).sqrt());
        Some(
            (-9.137_773_141_758_155
                + x * (-1_644.724_479_150_889
                    + x * (-28_105.096_098_779_683 + x * 3_896.079_810_390_921_5)))
                / (1.
                    + x * (272.375_261_351_239_7
                        + x * (7_929.224_261_291_35 + x * 23_980.122_860_821_313))),
        )
    } else if z <= -0.005_480_012_945_209_444 {
        // W >= -7.178, Y_-4
        let x = -z / (X0 + (z - Z0).sqrt());
        Some(
            (-10.603_388_239_566_373
                + x * (-7_733.348_521_498_648
                    + x * (-575_482.407_079_644_3 + x * (-2.154_552_604_188_978e6))))
                / (1.
                    + x * (1_021.793_856_606_681_7
                        + x * (111_300.229_154_865_21 + x * 1.261_425_640_008_844_2e6))),
        )
    } else if z <= -0.001_367_466_989_250_804_2 {
        // W >= -8.766, Y_-5
        let x = -z / (X0 + (z - Z0).sqrt());
        Some(
            (-12.108_699_273_343_438
                + x * (-36_896.535_108_166_376
                    + x * (-1.183_112_672_010_605_4e7 + x * (-2.756_583_081_394_092_4e8))))
                / (1.
                    + x * (4_044.975_306_488_07
                        + x * (1.741_827_761_903_000_5e6 + x * 7.843_690_738_080_69e7))),
        )
    } else if z <= -0.000_326_142_267_310_725_66 {
        // W >= -10.367, Y_-6
        let x = -z / (X0 + (z - Z0).sqrt());
        Some(
            (-13.646_761_936_746_191
                + x * (-179_086.115_857_151_48
                    + x * (-2.508_463_493_521_464_2e8 + x * (-2.934_370_049_483_371_4e10))))
                / (1.
                    + x * (16_743.826_607_737_14
                        + x * (2.980_965_094_601_174_4e7 + x * 5.573_951_481_695_8e9))),
        )
    } else if z <= -0.000_074_906_612_036_101_44 {
        // W >= -11.983, Y_-7
        let x = -z / (X0 + (z - Z0).sqrt());
        Some(
            (-15.212_958_142_001_646
                + x * (-884_954.687_981_689_6
                    + x * (-5.529_815_437_863_348e9 + x * (-3.093_418_743_531_467e12))))
                / (1.
                    + x * (72_009.255_525_210_12
                        + x * (5.505_900_767_187_58e8 + x * 4.432_489_486_700_034e11))),
        )
    } else if z <= -1.096_244_452_641_099_5e-19 {
        // W >= -47.518, V_-8
        let u = (-z).ln();
        Some(
            (-0.032_401_163_177_791_084
                + u * (2.028_194_214_474_250_4
                    + u * (-0.527_524_312_425_927_1 + u * 0.017_340_294_772_717_584)))
                / (1.
                    + u * (-0.450_042_744_438_917_4
                        + u * (0.017_154_705_753_566_295 + u * (-5.243_819_620_271_836e-7)))),
        )
    } else if z <= -2.509_609_929_994_59e-136 {
        // W >= -317.993, V_-9
        let u = (-z).ln();
        Some(
            (-1.441_124_659_581_209_7
                + u * (1.281_926_963_998_047_7
                    + u * (-0.074_979_356_113_812_33 + u * 0.000_476_363_091_620_691_5)))
                / (1.
                    + u * (-0.072_000_873_723_868_65
                        + u * (0.000_475_489_329_895_970_3 + u * (-4.171_497_924_754_684e-10)))),
        )
    } else if z < 0.0 {
        // V_-10
        let u = (-z).ln();
        Some(
            (-3.310_876_091_171_045
                + u * (1.050_067_880_993_517_6
                    + u * (-0.008_236_749_582_134_32 + u * 5.528_956_159_491_019e-6)))
                / (1.
                    + u * (-0.008_189_272_743_331_552
                        + u * (5.528_007_600_971_195e-6 + u * (-3.922_277_308_457_406_3e-14)))),
        )
    } else {
        None
    }
}

#[cfg(feature = "fma")]
// This is the same function as above, but the polynomials have been reduced to their third degree form.
pub fn swm1(z: f64) -> Option<f64> {
    if z < Z0 {
        None
    } else if z <= -0.207_293_777_640_384_15 {
        // W >= -2.483, Y_-1

        let x = -z / (X0 + (z - Z0).sqrt());
        let x2 = x * x;

        Some(
            poly_3(
                x,
                x2,
                -6.38372282280191,
                -74.968653259594,
                -19.7148215524325,
                70.6773266678092,
            ) / poly_3(
                x,
                x2,
                1.0,
                24.2958369518787,
                64.112460611386,
                17.9944973690393,
            ),
        )
    } else if z <= -0.071_507_705_083_841_95 {
        // W >= -4.032, Y_-2

        let x = -z / (X0 + (z - Z0).sqrt());
        let x2 = x * x;

        Some(
            poly_3(
                x,
                x2,
                -7.72332848122998,
                -352.484690970429,
                -1242.00889036857,
                1171.64759606205,
            ) / poly_3(
                x,
                x2,
                1.0,
                77.6812425889974,
                648.564312140752,
                566.701549764362,
            ),
        )
    } else if z <= -0.020_704_412_621_717_48 {
        // W >= -5.600, Y_-3

        let x = -z / (X0 + (z - Z0).sqrt());
        let x2 = x * x;

        Some(
            poly_3(
                x,
                x2,
                -9.13777314175815,
                -1644.72447915089,
                -28105.0960987797,
                3896.07981039092,
            ) / poly_3(
                x,
                x2,
                1.0,
                272.37526135124,
                7929.22426129135,
                23980.1228608213,
            ),
        )
    } else if z <= -0.005_480_012_945_209_444 {
        // W >= -7.178, Y_-4

        let x = -z / (X0 + (z - Z0).sqrt());
        let x2 = x * x;

        Some(
            poly_3(
                x,
                x2,
                -10.6033882395664,
                -7733.34852149865,
                -575482.407079644,
                -2154552.60418898,
            ) / poly_3(
                x,
                x2,
                1.0,
                1021.79385660668,
                111300.229154865,
                1261425.64000884,
            ),
        )
    } else if z <= -0.001_367_466_989_250_804_2 {
        // W >= -8.766, Y_-5

        let x = -z / (X0 + (z - Z0).sqrt());
        let x2 = x * x;

        Some(
            poly_3(
                x,
                x2,
                -12.1086992733434,
                -36896.5351081664,
                -11831126.7201061,
                -275658308.139409,
            ) / poly_3(
                x,
                x2,
                1.0,
                4044.97530648807,
                1741827.761903,
                78436907.3808069,
            ),
        )
    } else if z <= -0.000_326_142_267_310_725_66 {
        // W >= -10.367, Y_-6

        let x = -z / (X0 + (z - Z0).sqrt());
        let x2 = x * x;

        Some(
            poly_3(
                x,
                x2,
                -13.6467619367462,
                -179086.115857151,
                -250846349.352146,
                -29343700494.8337,
            ) / poly_3(
                x,
                x2,
                1.0,
                16743.8266077371,
                29809650.9460117,
                5573951481.6958,
            ),
        )
    } else if z <= -0.000_074_906_612_036_101_44 {
        // W >= -11.983, Y_-7

        let x = -z / (X0 + (z - Z0).sqrt());
        let x2 = x * x;

        Some(
            poly_3(
                x,
                x2,
                -15.2129581420016,
                -884954.68798169,
                -5529815437.86335,
                -3093418743531.47,
            ) / poly_3(
                x,
                x2,
                1.0,
                72009.2555252101,
                550590076.718758,
                443248948670.003,
            ),
        )
    } else if z <= -1.096_244_452_641_099_5e-19 {
        // W >= -47.518, V_-8

        let u = (-z).ln();
        let u2 = u * u;

        Some(
            poly_3(
                u,
                u2,
                -0.0324011631777911,
                2.02819421447425,
                -0.527524312425927,
                0.0173402947727176,
            ) / poly_3(
                u,
                u2,
                1.0,
                -0.450042744438917,
                0.0171547057535663,
                -5.24381962027184e-7,
            ),
        )
    } else if z <= -2.509_609_929_994_59e-136 {
        // W >= -317.993, V_-9
        let u = (-z).ln();
        Some(
            (-1.441_124_659_581_209_7
                + u * (1.281_926_963_998_047_7
                    + u * (-0.074_979_356_113_812_33 + u * 0.000_476_363_091_620_691_5)))
                / (1.
                    + u * (-0.072_000_873_723_868_65
                        + u * (0.000_475_489_329_895_970_3 + u * (-4.171_497_924_754_684e-10)))),
        )
    } else if z < 0.0 {
        // V_-10
        let u = (-z).ln();
        Some(
            (-3.310_876_091_171_045
                + u * (1.050_067_880_993_517_6
                    + u * (-0.008_236_749_582_134_32 + u * 5.528_956_159_491_019e-6)))
                / (1.
                    + u * (-0.008_189_272_743_331_552
                        + u * (5.528_007_600_971_195e-6 + u * (-3.922_277_308_457_406_3e-14)))),
        )
    } else {
        None
    }
}
