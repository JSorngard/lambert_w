//! This module contains an implementation of the approximation of the secondary
//! branch of the Lambert W function
//! with 50 bits of accuracy from Fukushima's paper.
//! It returns [`f64::NAN`] if the `zc` input is negative,
//! or if the `z` input is `NAN`, or larger than or equal to 0.

use crate::{
    generic_math::{ln, rational_function, sqrt},
    INV_SQRT_E, NEG_INV_E,
};

/// zc = z + 1/e
#[inline(always)]
#[cfg_attr(all(test, assert_no_panic), no_panic::no_panic)]
pub fn dwm1c(z: f64, zc: f64) -> f64 {
    if zc < 0.0 {
        f64::NAN
    } else if z <= -0.3542913309442164 {
        // W >= -1.3, X_-1

        rational_function(
            sqrt(zc),
            [
                -1.0000000000000001110,
                4.2963016178777127009,
                -4.0991407924007457612,
                -6.8442842200833309724,
                17.084773793345271001,
                -13.015133123886661124,
                3.9303608629539851049,
                -0.34636746512247457319,
            ],
            [
                1.0,
                -6.6279455994747624059,
                17.740962374121397994,
                -24.446872319343475890,
                18.249006287190617068,
                -7.0580758756624790550,
                1.1978786762794003545,
                -0.053875778140352599789,
            ],
        )
    } else if z <= -0.18872688282289434049 {
        // W >= -2.637, Y_-1

        rational_function(
            -z / (INV_SQRT_E + sqrt(z - NEG_INV_E)),
            [
                -8.2253155264446844854,
                -813.20706732001487178,
                -15270.113237678509000,
                -79971.585089674149237,
                -103667.54215808376511,
                42284.755505061257427,
                74953.525397605484884,
                10554.369146366736811,
            ],
            [
                1.0,
                146.36315161669567659,
                3912.4761372539240712,
                31912.693749754847460,
                92441.293717108619527,
                94918.733120470346165,
                29531.165406571745340,
                1641.6808960330370987,
            ],
        )
    } else if z <= -0.060497597226958343647 {
        // W >= -4.253, Y_-2

        rational_function(
            -z / (INV_SQRT_E + sqrt(z - NEG_INV_E)),
            [
                -9.6184127443354024295,
                -3557.8569043018004121,
                -254015.59311284381043,
                -5.3923893630670639391e6,
                -3.6638257417536896798e7,
                -6.1484319486226966213e7,
                3.0421690377446134451e7,
                3.9728139054879320452e7,
            ],
            [
                1.0,
                507.40525628523300801,
                46852.747159777876192,
                1.3168304640091436297e6,
                1.3111690693712415242e7,
                4.6142116445258015195e7,
                4.8982268956208830876e7,
                9.1959100987983855122e6,
            ],
        )
    } else if z <= -0.017105334740676008194 {
        // W >= -5.832, Y_-3

        rational_function(
            -z / (INV_SQRT_E + sqrt(z - NEG_INV_E)),
            [
                -11.038489462297466388,
                -15575.812882656619195,
                -4.2492947304897773433e6,
                -3.5170245938803423768e8,
                -9.8659163036611364640e9,
                -8.6195372303305003908e10,
                -1.3286335574027616000e11,
                1.5989546434420660462e11,
            ],
            [
                1.0,
                1837.0770693017166818,
                612840.97585595092761,
                6.2149181398465483037e7,
                2.2304011314443083969e9,
                2.8254232485273698021e10,
                1.0770866639543156165e11,
                7.1964698876049131992e10,
            ],
        )
    } else if z <= -0.0045954962127943706433 {
        // W >= -7.382, Y_-4

        rational_function(
            -z / (INV_SQRT_E + sqrt(z - NEG_INV_E)),
            [
                -12.474405916395746052,
                -68180.335575543773385,
                -7.1846599845620093278e7,
                -2.3142688221759181151e10,
                -2.5801378337945295130e12,
                -9.5182748161386314616e13,
                -8.6073250986210321766e14,
                1.4041941853339961439e14,
            ],
            [
                1.0,
                6852.5813734431100971,
                8.5153001025466544379e6,
                3.2146028239685694655e9,
                4.2929807417453196113e11,
                2.0234381161638084359e13,
                2.8699933268233923842e14,
                7.1210136651525477096e14,
            ],
        )
    } else if z <= -0.0012001610672197724173 {
        // W >= -8.913, Y_-5

        rational_function(
            -z / (INV_SQRT_E + sqrt(z - NEG_INV_E)),
            [
                -13.921651376890072595,
                -298789.56482388065526,
                -1.2313019937322092334e9,
                -1.5556149081899508970e12,
                -6.8685341106772708734e14,
                -1.0290616275933266835e17,
                -4.1404683701619648471e18,
                -1.4423309998006368397e19,
            ],
            [
                1.0,
                26154.955236499142433,
                1.2393087277442041494e8,
                1.7832922702470761113e11,
                9.0772608163810850446e13,
                1.6314734740054252741e16,
                8.8371323861233504533e17,
                8.4166620643385013384e18,
            ],
        )
    } else if z <= -0.00030728805932191499844 {
        // W >= -10.433, Y_-6

        rational_function(
            -z / (INV_SQRT_E + sqrt(z - NEG_INV_E)),
            [
                -15.377894224591557534,
                -1.3122312005096979952e6,
                -2.1408157022111737888e10,
                -1.0718287431557811808e14,
                -1.8849353524027734456e17,
                -1.1394858607309311995e20,
                -1.9261555088729141590e22,
                -3.9978452086676901296e23,
            ],
            [
                1.0,
                101712.86771760620046,
                1.8728545945050381188e9,
                1.0469617416664402757e13,
                2.0704349060120443049e16,
                1.4464907902386074496e19,
                3.0510432205608900949e21,
                1.1397589139790739717e23,
            ],
        )
    } else if z <= -0.000077447159838062184354 {
        // W >= -11.946, Y_-7

        rational_function(
            -z / (INV_SQRT_E + sqrt(z - NEG_INV_E)),
            [
                -16.841701411264981596,
                -5.7790823257577138416e6,
                -3.7757230791256404116e11,
                -7.5712133742589860941e15,
                -5.3479338916011465685e19,
                -1.3082711732297865476e23,
                -9.1462777004521427440e25,
                -8.9602768119263629340e27,
            ],
            [
                1.0,
                401820.46666230725328,
                2.9211518136900492046e10,
                6.4456135373410289079e14,
                5.0311809576499530281e18,
                1.3879041239716289478e22,
                1.1575146167513516225e25,
                1.7199220185947756654e27,
            ],
        )
    } else if z <= -4.5808119698158173174e-17 {
        // W >= -41.344, V_-8

        rational_function(
            ln(-z),
            [
                -2.0836260384016439265e0,
                1.6122436242271495710e0,
                5.4464264959637207619e0,
                -3.0886331128317160105e0,
                0.46107829155370137880e0,
                -0.023553839118456381330e0,
                0.00040538904170253404780e0,
                -1.7948156922516825458e-6,
            ],
            [
                1.,
                2.3699648912703015610,
                -2.1249449707404812847,
                0.38480980098588483913,
                -0.021720009380176605969,
                0.00039405862890608636876,
                -1.7909312066865957905e-6,
                3.1153673308133671452e-12,
            ],
        )
    } else if z <= -6.1073672236594792982e-79 {
        // W >= -185.316, V_-9

        rational_function(
            ln(-z),
            [
                0.16045383766570541409,
                2.2214182524461514029,
                -0.94119662492050892971,
                0.091921523818747869300,
                -0.0029069760533171663224,
                0.000032707247990255961149,
                -1.2486672336889893018e-7,
                1.2247438279861785291e-10,
            ],
            [
                1.,
                -0.702_549_960_878_703_4,
                0.080_974_347_786_703_19,
                -0.002_746_985_002_956_315_3,
                0.000_031_943_362_385_183_66,
                -1.239_062_068_732_166_7e-7,
                1.224_163_611_516_82e-10,
                -1.027_571_802_054_676_6e-17,
            ],
        )
    } else if z < 0.0 {
        // V_-10

        rational_function(
            ln(-z),
            [
                -1.2742179703075440564,
                1.3696658805421383765,
                -0.12519345387558783223,
                0.0025155722460763844737,
                -0.000015748033750499977208,
                3.4316085386913786410e-8,
                -2.5025242885340438533e-11,
                4.6423885014099583351e-15,
            ],
            [
                1.0,
                -0.11420006474152465694,
                0.0024285233832122595942,
                -0.000015520907512751723152,
                3.4120534760396002260e-8,
                -2.4981056186450274587e-11,
                4.6419768093059706079e-15,
                -1.3608713936942602985e-23,
            ],
        )
    } else {
        f64::NAN
    }
}
